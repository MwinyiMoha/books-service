{% extends 'base.html' %}

{% block extra-css %}
	{{ block.super }}

	<style>
		.receipt-wrapper {
			width: 400px;
			display: none;
		}

		.th-color {
			color: rgb(128, 0, 128);
		}

		.th-bg {
			background-color: rgb(128, 0, 128);
		}
	</style>

{% endblock %}

{% block content %}

	<div class="list-wrapper">
		<h5 class="mb-3">Book List</h5>

		<ul class="list-unstyled book-list"></ul>

		<input class="mb-3 days-rented" type="number" placeholder="No of days" />
		<br>

		<button class="btn btn-primary rent-book">
			Rent Selected
		</button>
	</div>

	<div class="mt-3 receipt-wrapper">

		<h4 class="th-color">BookRent Service</h4>

		<div class="mt-3 ">
			<div>
				Created: <span class="date"></span>
			</div>

			<div>
				Receipt No: <span class="short-id"></span>
			</div>

			<div>
				Days Rented: <span class="period"></span>
			</div>
		</div>

		<table class="table table-striped table-sm mt-3">
			<thead class="th-bg text-white">
				<th>#</th>
				<th>Book Title</th>
				<th>Author</th>
			</thead>

			<tbody class="tbody">

			</tbody>
		</table>

		<div class="mt-3">
			<div>
				Charges: <span class="charge"></span>
			</div>

			<div>
				Return Date: <span class="return-date"></span>
			</div>
		</div>

	</div>

{% endblock %}


{% block extra-js %}

<script type="text/javascript">

	const bookList = document.querySelector('.book-list');
	const listSection = document.querySelector('.list-wrapper');
	const receiptSection = document.querySelector('.receipt-wrapper');

	let daysRented = 0;
	const dayInput = document.querySelector('.days-rented');
	dayInput.addEventListener('change', e => daysRented = e.target.value);

	let selectedBooks = [];

	const generateRow = (book, index) => {
		const tableBody = document.querySelector('.tbody')
		const row = tableBody.insertRow();

		const numberCell = row.insertCell()
		const numberCellText = document.createTextNode(index +1);
		numberCell.appendChild(numberCellText);

		const titleCell = row.insertCell()
		const titleCellText = document.createTextNode(book.title);
		titleCell.appendChild(titleCellText);

		const authorCell = row.insertCell()
		const authorCellText = document.createTextNode(book.author);
		authorCell.appendChild(authorCellText);
	}

	const showRentDetail = bookRent => {
		const shortId = bookRent.id.split('-')[0].toUpperCase();
		document.querySelector('.short-id').textContent = shortId
		document.querySelector('.period').textContent = bookRent.days_rented
		document.querySelector('.charge').textContent = bookRent.rent_charge
		document.querySelector('.return-date').textContent = bookRent.return_date.split('T')[0]
		document.querySelector('.date').textContent = bookRent.created.split('T')[0]

		bookRent.book_list.map((b, ix) => generateRow(b, ix))

		listSection.style.display = 'none';
		receiptSection.style.display = 'block';
	}

	const createRentRecord = async () => {
		const postData = {
			days_rented: parseInt(daysRented),
			books: selectedBooks
		}

		try{
			const response = await fetch('/api/v1/book-rents/', {
				method: 'POST',
				headers: new Headers({'Content-Type': 'application/json'}),
				body: JSON.stringify(postData)
			});

			const data = await response.json()
			showRentDetail(data);
		}catch(err) {
			console.error(err)
		}
	}

	const handleButton = evt => {
		if(!selectedBooks.length || !daysRented > 0){
			alert('You must first select a book to rent and set the number of days');
			return;
		}

		createRentRecord();
	}

	const initButton = document.querySelector('.rent-book');
	initButton.addEventListener('click', handleButton);

	const updateSelected = () => {
		const checks = document.querySelectorAll('input[type=checkbox]');
		selectedBooks = Array.from(checks).filter(c => c.checked).map(i => i.getAttribute('value'));
	};

	const generateItem = book => {
		const li = document.createElement('li');
		const text = document.createTextNode(`${book.title} By ${book.author}`);

		const check = document.createElement('input');
		check.type = 'checkbox';
		check.value = book.id;
		check.style.marginRight = '10px';
		check.addEventListener('change', updateSelected)

		li.appendChild(check);
		li.appendChild(text);
		bookList.appendChild(li);
	}

	window.onload = async (evt) => {
		const response = await fetch('/api/v1/books/');
		const data = await response.json()
		data.map(book => generateItem(book))
	};
</script>

{% endblock %}
